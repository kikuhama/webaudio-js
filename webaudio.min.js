WebAudio.STOPPING_STATE=0;WebAudio.PLAYING_STATE=1;WebAudio.PAUSING_STATE=2;function WebAudio(){this.webAudioApiSupported=false;this.forceUseHtml5Audio=false;this.audioContext=null;this.masterGain=null;this.state=WebAudio.STOPPING_STATE;this.loadedBuffers={};var c=(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext);var a=undefined;if(c){a=new c();if(a){this.webAudioApiSupported=true;this.audioContext=a;var b;if(this.audioContext.createGain){b=this.audioContext.createGain()}else{if(this.audioContext.createGainNode){b=this.audioContext.createGainNode()}}b.connect(this.audioContext.destination);this.masterGain=b}}}WebAudio.instance=function(){if(!WebAudio._instance){WebAudio._instance=new WebAudio()}return WebAudio._instance};WebAudio.prototype.setForceUseHtml5Audio=function(a){this.forceUseHtml5Audio=a};WebAudio.prototype.isWebAudioApiSupported=function(){return this.webAudioApiSupported};WebAudio.prototype.useWebAudioApi=function(){return(this.webAudioApiSupported&&!this.forceUseHtml5Audio)};WebAudio.prototype.loadUrl=function(b,e){var d=this;if(this.useWebAudioApi()){var c=function(f){d.loadedBuffers[b]=f[0];if(e){e()}};var a=new BufferLoader(this.audioContext,[b],c);a.load()}};WebAudio.prototype.playByUrl=function(a,g){var f=this;if(this.useWebAudioApi()){var e=function(h){f.loadedBuffers[a]=h[0];f.playBuffer(h[0],g)};if(this.loadedBuffers[a]){this.playBuffer(this.loadedBuffers[a],g,0)}else{this.loadUrl(a,function(){f.playBuffer(f.loadedBuffers[a],g,0)})}}else{var d;if(f.currentPlaylist){for(var b=0;b<f.currentPlaylist.length;++b){var c=f.currentPlaylist[b];if(c.src&&c.src==a){d=c}}}if(!d){d=new Audio(a)}f.playHtml5Audio(d,g)}};WebAudio.prototype.playListItem=function(){var e=this;if(e.currentPlaylistIndex<0){throw"Invalid playlist index"}else{if(e.currentPlaylistIndex<e.currentPlaylist.length){var d=this.currentPlaylist[e.currentPlaylistIndex];var b={src:null,duration:0};if($.isNumeric(d)){b.src=null;b.duration=d;var c=new Date();e.intervalTimeoutFunction=function(){e.intervalTimerId=null;e.intervalStartTime=null;e.currentIntervalTime=null;e.intervalTimeoutFunction=null;e.currentPlaylistIndex++;e.playListItem()};e.currentIntervalTime=d;e.intervalStartTime=c.getTime();e.intervalTimerId=setTimeout(e.intervalTimeoutFunction,d)}else{if(d.play!==undefined){b.src=d.src;e.playHtml5Audio(d,function(){e.currentPlaylistIndex++;e.playListItem()})}else{b.src=d;e.playByUrl(d,function(){e.currentPlaylistIndex++;e.playListItem()})}}if(e.playItemHandler){e.playItemHandler(b)}if(e.currentPlaylistIndex<this.currentPlaylist.length-1){var a=this.currentPlaylist[e.currentPlaylistIndex+1];if(!$.isNumeric(a)&&a.play==undefined){e.loadUrl(a)}}}else{e.state=WebAudio.STOPPING_STATE;if(e.playlistFinishedHandler){e.playlistFinishedHandler()}}}};WebAudio.prototype.playByList=function(d,a,c){var b=this;this.currentPlaylist=d;this.currentPlaylistIndex=0;this.playItemHandler=a;this.playlistFinishedHandler=c;if(this.useWebAudioApi()){this.loadUrl(d[0],function(){b.playListItem()})}else{b.playListItem()}};WebAudio.prototype.preloadHtml5AudioPlaylist=function(e,a,d){if(!this.useWebAudioApi()){var c=0;var b=0;$.each(e,function(f,g){if(g&&!$.isNumeric(g)){b++}});$.each(e,function(f,h){if(h&&!$.isNumeric(h)){var g=new Audio(h);$(g).on("loadeddata",function(){c++;if(a){a(c/b)}if(c==b&&d){d(e)}});g.load();e[f]=g}})}};WebAudio.prototype.playHtml5Audio=function(a,b){$(a).bind("ended",function(c){if(b){b()}$(a).unbind("ended")});a.autoplay=false;a.play();this.currentAudio=a;this.state=WebAudio.PLAYING_STATE};WebAudio.prototype.playBuffer=function(b,f,a){var d=this.audioContext.createBufferSource();var c=function(){if(f){f()}d.disconnect(0);this.currentBuffer=null;this.currentSource=null;this.playingTimerId=null;this.playFinishedHandler=null;this.state=WebAudio.STOPPING_STATE};var e=b.duration*1000;var g=a%e;d.buffer=b;this.currentBuffer=b;d.connect(this.masterGain);if(d.start){d.start(0,g)}else{d.noteOn(0,g)}this.startTime=this.audioContext.currentTime;this.currentSource=d;this.state=WebAudio.PLAYING_STATE;this.playingTimerId=setTimeout(c,e-g);this.playFinishedHandler=f};WebAudio.prototype.pause=function(){if(this.state==WebAudio.PLAYING_STATE){if(this.intervalTimerId){clearTimeout(this.intervalTimerId);this.intervalTimerId=null;var a=new Date();this.currentIntervalTime-=(a.getTime()-this.intervalStartTime);this.intervalStartTime=null}else{if(this.useWebAudioApi()){if(this.currentSource&&this.playingTimerId){clearTimeout(this.playingTimerId);this.currentSource.stop(0);this.currentSource.disconnect(0);this.currentSource=null;this.playingTimerId=null;this.startOffset=this.audioContext.currentTime-this.startTime}}else{if(this.currentAudio){this.currentAudio.pause()}}}this.state=WebAudio.PAUSING_STATE}};WebAudio.prototype.resume=function(){if(this.state==WebAudio.PAUSING_STATE){if(this.currentIntervalTime){setTimeout(this.intervalTimeoutFunction,this.currentIntervalTime)}else{if(this.useWebAudioApi()){if(this.currentBuffer&&this.startOffset!=undefined){this.playBuffer(this.currentBuffer,this.playFinishedHandler,this.startOffset)}}else{if(this.currentAudio){this.currentAudio.play();this.state=WebAudio.PLAYING_STATE}}}}};WebAudio.prototype.replayCurrentListItem=function(){if(this.currentPlaylist){this.pause();var a=this.currentPlaylist[this.currentPlaylistIndex];while($.isNumeric(a)){if(this.currentPlaylistIndex>0){this.currentPlaylistIndex--;a=this.currentPlaylist[this.currentPlaylistIndex];this.currentIntervalTime=null}else{this.resume();return}}this.playListItem()}};WebAudio.prototype.playPrevListItem=function(){if(this.currentPlaylist){this.pause();this.currentIntervalTime=null;this.currentPlaylistIndex-=2;if(this.currentPlaylistIndex<0){this.currentPlaylistIndex=0}var a=this.currentPlaylist[this.currentPlaylistIndex];while($.isNumeric(a)){if(this.currentPlaylistIndex>0){this.currentPlaylistIndex--;a=this.currentPlaylist[this.currentPlaylistIndex]}else{this.resume();return}}this.playListItem()}};WebAudio.prototype.playNextListItem=function(){if(this.currentPlaylist){this.pause();this.currentIntervalTime=null;if(this.currentPlaylistIndex>=this.currentPlaylist.length-1){return}this.currentPlaylistIndex++;var a=this.currentPlaylist[this.currentPlaylistIndex];while($.isNumeric(a)){if(this.currentPlaylistIndex>=this.currentPlaylist.length-1){return}this.currentPlaylistIndex++;a=this.currentPlaylist[this.currentPlaylistIndex]}if(this.useWebAudioApi()){this.loadUrl(a,function(){WebAudio.instance().playListItem()})}else{$(this.currentAudio).unbind("ended");WebAudio.instance().playListItem()}}};WebAudio.prototype.isPlaying=function(){return(this.state==WebAudio.PLAYING_STATE)};WebAudio.prototype.isStopping=function(){return(this.state==WebAudio.STOPPING_STATE)};WebAudio.prototype.isPausing=function(){return(this.state==WebAudio.PAUSING_STATE)};WebAudio.prototype.destroyBufferByUrl=function(a){if(this.loadedBuffers[a]){this.loadedBuffers[a]=null}};WebAudio.prototype.clearBuffers=function(){this.loadedBuffers={}};function BufferLoader(b,a,c){this.context=b;this.urlList=a;this.onload=c;this.bufferList=new Array();this.loadCount=0}BufferLoader.prototype.loadBuffer=function(c,b){var d=new XMLHttpRequest();d.open("GET",c,true);d.responseType="arraybuffer";var a=this;d.onload=function(){a.context.decodeAudioData(d.response,function(e){if(!e){alert("error decoding file data: "+c);return}a.bufferList[b]=e;if(++a.loadCount==a.urlList.length){a.onload(a.bufferList)}},function(e){console.error("decodeAudioData error",e)})};d.onerror=function(){alert("BufferLoader: XHR error")};d.send()};BufferLoader.prototype.load=function(){for(var a=0;a<this.urlList.length;++a){this.loadBuffer(this.urlList[a],a)}};